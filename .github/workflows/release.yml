name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build and test before releasing
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --workspace -- -D warnings

      - name: Build
        run: cargo build --release --workspace

      - name: Test
        run: cargo test --workspace

  # Create GitHub Release first (before uploading binaries)
  create-release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          generate_release_notes: true

  # Build and upload binaries for all platforms
  upload-binaries:
    needs: create-release
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: numr,numr-cli
          target: ${{ matrix.target }}
          archive: numr-$tag-$target
          token: ${{ secrets.GITHUB_TOKEN }}

  # Update AUR package (binary)
  aur:
    needs: upload-binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download binary and get sha256
        id: sha256
        run: |
          curl -sL "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/numr-v${{ steps.version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz" -o binary.tar.gz
          echo "sha256=$(sha256sum binary.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Update PKGBUILD
        run: |
          sed -i "s/^pkgver=.*/pkgver=${{ steps.version.outputs.version }}/" aur/PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${{ steps.sha256.outputs.sha256 }}')/" aur/PKGBUILD

      - name: Generate .SRCINFO
        uses: docker://archlinux:latest
        with:
          entrypoint: bash
          args: |
            -c "
            pacman -Sy --noconfirm base-devel &&
            useradd -m builder &&
            chown -R builder:builder aur &&
            cd aur &&
            su builder -c 'makepkg --printsrcinfo > .SRCINFO'
            "

      - name: Publish to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: numr
          pkgbuild: ./aur/PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ steps.version.outputs.version }}"
          assets: |
            ./aur/.SRCINFO

  # Update Homebrew tap
  homebrew:
    needs: upload-binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download binaries and get sha256
        id: sha256
        run: |
          curl -sL "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/numr-v${{ steps.version.outputs.version }}-aarch64-apple-darwin.tar.gz" -o arm.tar.gz
          curl -sL "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/numr-v${{ steps.version.outputs.version }}-x86_64-apple-darwin.tar.gz" -o intel.tar.gz
          echo "sha256_arm=$(sha256sum arm.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "sha256_intel=$(sha256sum intel.tar.gz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          sed -i 's/version ".*"/version "${{ steps.version.outputs.version }}"/' homebrew/numr.rb
          # Update ARM sha256 (line after on_arm do)
          sed -i '/on_arm do/{n;n;s/sha256 ".*"/sha256 "${{ steps.sha256.outputs.sha256_arm }}"/}' homebrew/numr.rb
          # Update Intel sha256 (line after on_intel do)
          sed -i '/on_intel do/{n;n;s/sha256 ".*"/sha256 "${{ steps.sha256.outputs.sha256_intel }}"/}' homebrew/numr.rb

      - name: Push to Homebrew tap
        uses: cpina/github-action-push-to-another-repository@v1.7.2
        env:
          SSH_DEPLOY_KEY: ${{ secrets.HOMEBREW_TAP_DEPLOY_KEY }}
        with:
          source-directory: homebrew
          destination-github-username: nasedkinpv
          destination-repository-name: homebrew-tap
          target-branch: main
          commit-message: "Update numr to ${{ steps.version.outputs.version }}"
