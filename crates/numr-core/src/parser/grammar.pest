// =============================================================================
// numr grammar - Natural language calculator expressions
// =============================================================================
//
// ADDING NEW CURRENCIES OR UNITS:
// 1. Add to the registry in types/currency.rs or types/unit.rs (source of truth)
// 2. Update the corresponding rules below (currency_symbol, currency_code, unit)
// 3. Update target_unit rule to include the new conversion target
//
// The registries in types/ are the source of truth for:
// - Parsing (Currency::parse, Unit::parse)
// - Display (symbol(), short_name())
// - Syntax highlighting (ui.rs reads from registries)
//
// This grammar file must be kept in sync with the registries manually.
// =============================================================================

// -----------------------------------------------------------------------------
// ENTRY POINT
// -----------------------------------------------------------------------------

line = { SOI ~ (assignment | expression)? ~ EOI }

// -----------------------------------------------------------------------------
// STATEMENTS
// -----------------------------------------------------------------------------

// Assignment: variable = expression
assignment = { identifier ~ "=" ~ expression }

// Expression: calculation optionally followed by conversion (e.g., "in usd")
expression = { calculation ~ conversion_suffix? }

// Calculation: terms connected by operators
calculation = { term ~ (operation ~ term)* }

// Conversion suffix: "in euros", "to km"
// Allows trailing prose text after the target unit (e.g., "in eur and some note here")
conversion_suffix = { ("in" | "to") ~ target_unit ~ trailing_text? }

// Trailing text after conversion - anything that doesn't look like an operator or continuation
// Must start with a non-operator, non-digit character sequence
trailing_text = _{ &ASCII_ALPHA ~ (!EOI ~ ANY)* }

// -----------------------------------------------------------------------------
// TERMS (atoms)
// -----------------------------------------------------------------------------

term = _{ atom }

atom = _{
    percentage_of       // "20% of 150"
    | function_call     // "sum(1, 2, 3)"
    | parenthesized     // "(1 + 2)"
    | percentage        // "20%"
    | currency_value    // "$100" or "100 USD"
    | suffixed_number   // "5 km" or "100 USD"
    | number            // "42.5"
    | variable_ref      // "tax"
}

parenthesized = { "(" ~ expression ~ ")" }

// -----------------------------------------------------------------------------
// OPERATORS (precedence handled in AST building)
// -----------------------------------------------------------------------------

operation = _{ add | subtract | multiply | divide | power }
add      = { "+" }
subtract = { "-" }
multiply = { "*" | "x" | "×" }
divide   = { "/" | "÷" }
power    = { "^" | "**" }

// -----------------------------------------------------------------------------
// SPECIAL EXPRESSIONS
// -----------------------------------------------------------------------------

// Percentage of: "20% of 150"
percentage_of = { percentage ~ "of" ~ atom }

// Function calls: sum(), avg(), min(), max(), sqrt(), etc.
function_call = { identifier ~ "(" ~ (expression ~ ("," ~ expression)*)? ~ ")" }

// -----------------------------------------------------------------------------
// VALUES
// -----------------------------------------------------------------------------

// Numbers: integers, decimals, scientific notation
// Supports comma-separated thousands: 1,234 or 1,234,567.89
number = @{
    "-"? ~ (
        // Comma-separated: 1,234 or 12,345 or 1,234,567
        ASCII_DIGIT{1,3} ~ ("," ~ ASCII_DIGIT{3})+ ~ ("." ~ ASCII_DIGIT+)?
        // Regular: 12345 or 12345.67
        | ASCII_DIGIT+ ~ ("." ~ ASCII_DIGIT+)?
    ) ~ (("e" | "E") ~ ("+" | "-")? ~ ASCII_DIGIT+)?
}

// Percentages: "20%"
percentage = { number ~ "%" }

// Currency values: "$100", "100 USD", "100$"
// Currency values with symbols: "$100", "100$"
currency_value = {
    (currency_symbol ~ number)
    | (number ~ currency_symbol)
}

// Suffixed number: "100 USD", "5 km", "100 x" (implicit multiplication)
suffixed_number = { number ~ identifier }

// -----------------------------------------------------------------------------
// CURRENCIES
// -----------------------------------------------------------------------------

// Currency symbols (single characters)
// Fiat: $ € £ ¥ ₽ ₪ ₹ ₩ ₴
// Crypto: ₿ Ξ ◎ ₮ ₳ Ð Ł
currency_symbol = { "$" | "€" | "£" | "¥" | "₽" | "₪" | "₹" | "₩" | "₴" | "₿" | "Ξ" | "◎" | "₮" | "₳" | "Ð" | "Ł" | "zł" }

// -----------------------------------------------------------------------------
// CONVERSION TARGETS
// -----------------------------------------------------------------------------

target_unit = { identifier }

// -----------------------------------------------------------------------------
// IDENTIFIERS AND VARIABLES
// -----------------------------------------------------------------------------

identifier = @{ "_" | (ASCII_ALPHA ~ (ASCII_ALPHANUMERIC | "_")*) }
variable_ref = { identifier }

// -----------------------------------------------------------------------------
// WHITESPACE AND COMMENTS
// -----------------------------------------------------------------------------

WHITESPACE = _{ " " | "\t" }
COMMENT = _{ ("#" | "//") ~ (!NEWLINE ~ ANY)* }
NEWLINE = _{ "\n" | "\r\n" }
