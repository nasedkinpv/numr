line = { SOI ~ (assignment | expression)? ~ trailing_text? ~ EOI }

// Exact line match without trailing prose - used for continuation detection
line_no_prose = { SOI ~ (assignment | expression)? ~ trailing_text? ~ EOI }

// -----------------------------------------------------------------------------
// STATEMENTS
// -----------------------------------------------------------------------------

// Assignment: variable = expression
assignment = { identifier ~ "=" ~ expression }

// Expression: calculation
expression = { calculation }

// Calculation: terms connected by operators
calculation = { term ~ (operation ~ term)* }

// Trailing text after conversion - anything that doesn't look like an operator or continuation
// Must start with a non-operator, non-digit character sequence
trailing_text = { &ASCII_ALPHA ~ (!EOI ~ ANY)* }

// -----------------------------------------------------------------------------
// TERMS (atoms)
// -----------------------------------------------------------------------------

term = _{ atom }

atom = _{
    percentage_of       // "20% of 150"
    | function_call     // "sum(1, 2, 3)"
    | parenthesized     // "(1 + 2)"
    | percentage        // "20%"
    | currency_value    // "$100" or "100 USD"
    | suffixed_number   // "5 km" or "100 USD"
    | number            // "42.5"
    | variable_ref      // "tax"
}

parenthesized = { "(" ~ expression ~ ")" }

// -----------------------------------------------------------------------------
// OPERATORS (precedence handled in AST building)
// -----------------------------------------------------------------------------

operation = _{ add | subtract | multiply | divide | power | conversion_op }
add      = { "+" }
subtract = { "-" }
multiply = { "*" | "x" | "×" }
divide   = { "/" | "÷" }
power    = { "^" | "**" }
conversion_op = { "in" | "to" }

// -----------------------------------------------------------------------------
// SPECIAL EXPRESSIONS
// -----------------------------------------------------------------------------

// Percentage of: "20% of 150"
percentage_of = { percentage ~ "of" ~ atom }

// Function calls: sum(), avg(), min(), max(), sqrt(), etc.
function_call = { identifier ~ "(" ~ (expression ~ ("," ~ expression)*)? ~ ")" }

// -----------------------------------------------------------------------------
// VALUES
// -----------------------------------------------------------------------------

// Numbers: integers, decimals, scientific notation
// Supports comma or space-separated thousands: 1,234 or 75 000 or 1,234,567.89
number = @{
    "-"? ~ (
        // Comma-separated: 1,234 or 12,345 or 1,234,567
        ASCII_DIGIT{1,3} ~ ("," ~ ASCII_DIGIT{3})+ ~ ("." ~ ASCII_DIGIT+)?
        // Space-separated: 75 000 or 1 234 567
        | ASCII_DIGIT{1,3} ~ (" " ~ ASCII_DIGIT{3})+ ~ ("." ~ ASCII_DIGIT+)?
        // Regular: 12345 or 12345.67
        | ASCII_DIGIT+ ~ ("." ~ ASCII_DIGIT+)?
    ) ~ (("e" | "E") ~ ("+" | "-")? ~ ASCII_DIGIT+)?
}

// Percentages: "20%"
percentage = { number ~ "%" }

// Currency values: "$100", "100 USD", "100$"
// Currency values with symbols: "$100", "100$"
currency_value = {
    (currency_symbol ~ number)
    | (number ~ currency_symbol)
}

// Suffixed number: "100 USD", "5 km", "100 x" (implicit multiplication), "20 in" (inches)
// Must not match conversion keywords ("in", "to") followed by identifier to avoid ambiguity
suffixed_number = { number ~ !keyword_with_target ~ identifier }

// Helper to identify when "in" or "to" are used as conversion operators
// Must be a standalone word followed by an identifier to be a conversion
keyword_with_target = @{ ("in" | "to") ~ !(ASCII_ALPHANUMERIC | "_") ~ WHITESPACE+ ~ identifier }

// -----------------------------------------------------------------------------
// CURRENCIES
// -----------------------------------------------------------------------------

// Currency symbols (single characters)
// Fiat: $ € £ ¥ ₽ ₪ ₹ ₩ ₴
// Crypto: ₿ Ξ ◎ ₮ ₳ Ð Ł
currency_symbol = { "$" | "€" | "£" | "¥" | "₽" | "₪" | "₹" | "₩" | "₴" | "₿" | "Ξ" | "◎" | "₮" | "₳" | "Ð" | "Ł" | "zł" }

// -----------------------------------------------------------------------------
// CONVERSION TARGETS
// -----------------------------------------------------------------------------

target_unit = { identifier }

// -----------------------------------------------------------------------------
// IDENTIFIERS AND VARIABLES
// -----------------------------------------------------------------------------

identifier = @{ "_" | (ASCII_ALPHA ~ (ASCII_ALPHANUMERIC | "_")*) }
variable_ref = { identifier }

// -----------------------------------------------------------------------------
// WHITESPACE AND COMMENTS
// -----------------------------------------------------------------------------

WHITESPACE = _{ " " | "\t" }
COMMENT = _{ ("#" | "//") ~ (!NEWLINE ~ ANY)* }
NEWLINE = _{ "\n" | "\r\n" }
